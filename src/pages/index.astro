---
import BaseLayout from "../layouts/BaseLayout.astro";
import TimerForm from "../components/TimerForm.astro";
---

<BaseLayout title="潜水艦タイマー設定">
  <h1>潜水艦タイマー設定</h1>
  <div id="submarines">
    <TimerForm id={1} />
    <TimerForm id={2} />
    <TimerForm id={3} />
    <TimerForm id={4} />
  </div>

  <button id="generate-url">URL生成</button>
  <p id="generated-url"></p>

  <script type="module">
    function calculateTimestamp(method, days, hours, minutes, absoluteTime) {
      if (method === "absolute") {
        return absoluteTime ? new Date(absoluteTime).getTime() : null;
      }

      const totalMilliseconds =
        (days || 0) * 86400000 +
        (hours || 0) * 3600000 +
        (minutes || 0) * 60000;

      return totalMilliseconds > 0 ? Date.now() + totalMilliseconds : null;
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("generate-url").addEventListener("click", () => {
        let params = [];
        for (let i = 1; i <= 4; i++) {
          let method = document.querySelector(
            `input[name="method${i}"]:checked`
          )?.value;
          let days = parseInt(
            document.getElementById(`days-${i}`)?.value || "0"
          );
          let hours = parseInt(
            document.getElementById(`hours-${i}`)?.value || "0"
          );
          let minutes = parseInt(
            document.getElementById(`minutes-${i}`)?.value || "0"
          );
          let absoluteTime = document.getElementById(
            `absolute-time-${i}`
          )?.value;

          let time = calculateTimestamp(
            method,
            days,
            hours,
            minutes,
            absoluteTime
          );

          if (time !== null) params.push(`time${i}=${time}`);
        }

        if (params.length === 0) {
          alert("入力してください！");
          return;
        }

        let generatedURL = `/timer?${params.join("&")}`;
        document.getElementById("generated-url").innerHTML =
          `<a href="${generatedURL}">${generatedURL}</a>`;
      });
    });
  </script>
</BaseLayout>
